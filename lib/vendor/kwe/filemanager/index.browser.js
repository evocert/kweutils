define([
	"module",
	"axios"
],function(
	module,
	axios
){
	"use strict";
	var svcurl=<@print(JSON.stringify(
		[
			action().Path().substring(0,action().Path().lastIndexOf("/")),
			"index.svc.js"
		].join("/")
	));@>;
	function FileManager(options){
		options=typeof(options)=="object"?options:{};
		options.cwd=typeof(options.cwd)=="string"?options.cwd:"./";
		this.cwd=options.cwd;
		this.ls=function(path){
			path=typeof(path)=="undefined"?"./":path;
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"ls",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.entries);
						}else{
							reject(response.data.error);
						}
					});
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				});
		};
		this.find=function(path){
			path=typeof(path)=="undefined"?"./":path;
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"find",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.entries);
						}else{
							reject(response.data.error);
						}
					});
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				});
		};

		this.pwd=function(){
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"pwd",
							args:{cwd:this.cwd}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.cwd);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};
		this.mkdir=function(path){
			if(typeof(path)!="string")throw("Invalid path");
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"mkdir",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.created);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};
		this.rm=function(path){
			if(typeof(path)!="string")throw("Invalid path");
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"rm",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.removed);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};

		this.touch=function(path){
			if(typeof(path)!="string")throw("Invalid path");
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"touch",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.created);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};
		this.setcontents=function(path,contents){
			if(typeof(path)!="string")throw("Invalid path");
			if(typeof(contents)!="string")throw("Invalid contents");
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"setcontents",
							args:{cwd:this.cwd,path:path,contents:contents}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.updated);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};
		this.cat=function(path){
			if(typeof(path)!="string")throw("Invalid path");
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"cat",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							resolve(response.data.contents);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};
		this.cd=function(path){
			path=typeof(path)=="undefined"?"./":path;
			return new Promise(
				function(resolve,reject){
					axios({
						method:"post",
						url:svcurl,
						data:{
							action:"cd",
							args:{cwd:this.cwd,path:path}
						}
					}).then(function(response){
						if(!response.data.error){
							this.cwd=response.data.cwd;
							resolve(response.data.cwd);
						}else{
							reject(response.data.error);
						}
					}.bind(this));
				}.bind(this),
				function(error){
					console.log(error);
					reject(error);
				}
			);
		};
	};
	module.exports=FileManager;
});
